<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title> Travel Planner üó∫ </title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js" crossorigin="anonymous"></script>

    <!-- Babel (–¥–ª—è JSX) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.0/babel.min.js" crossorigin="anonymous"></script>

    <!-- Leaflet CSS (–¥–ª—è –∫–∞—Ä—Ç–∏) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Leaflet Routing Machine (–ü–ª–∞–≥—ñ–Ω –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>


    <style>
        .leaflet-container { height: 100%; width: 100%; }
        .leaflet-container.add-mode-cursor { cursor: crosshair !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .leaflet-routing-container.leaflet-bar { display: none !important; }
        .dragging { opacity: 0.5; background: #334155; }
        .drag-over { border-top: 2px solid #6366f1; }

        /* –î–æ–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ –¥–ª—è —ñ–∫–æ–Ω–æ–∫, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ —Ç–µ–ø–µ—Ä SVG */
        i[data-lucide] {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans antialiased h-screen">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
{% raw %}
        // –ì–ª–æ–±–∞–ª—å–Ω–∞ –¥–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü—ñ—è
        const { useState, useEffect, useRef, useMemo } = React;

        // =====================================================================
        // GLOBAL SETTINGS
        // =====================================================================
        const API_BASE_URL = '/api';
        const OPENWEATHER_API_KEY = "8d0fb6e3ff2da2740be369ffaae8a97c";

        // =====================================================================
        // API CLIENT
        // =====================================================================
        const apiFetch = (url, options = {}) => {
            return new Promise(async (resolve, reject) => {
                try {
                    options.headers = options.headers || {};
                    if (options.body) {
                        options.headers['Content-Type'] = 'application/json';
                    }
                    const response = await fetch(`${API_BASE_URL}${url}`, options);
                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            errorData = { error: `HTTP error! status: ${response.status}` };
                        }
                        return reject(errorData);
                    }
                    if (response.status === 204) {
                        return resolve(null);
                    }
                    const data = await response.json();
                    resolve(data);
                } catch (error) {
                    console.error("Fetch error:", error);
                    reject({ error: "Network error. Server is not responding or an error occurred." });
                }
            });
        };

        // =====================================================================
        // HOOKS (–¥–ª—è debounce)
        // =====================================================================
        function useDebounce(callback, delay) {
            const timeoutRef = useRef(null);

            useEffect(() => {
                // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ —Ä–æ–∑–º–æ–Ω—Ç—É–≤–∞–Ω–Ω—ñ
                return () => {
                    if (timeoutRef.current) {
                        clearTimeout(timeoutRef.current);
                    }
                };
            }, []);

            function debouncedCallback(...args) {
                if (timeoutRef.current) {
                    clearTimeout(timeoutRef.current);
                }
                timeoutRef.current = setTimeout(() => {
                    callback(...args);
                }, delay);
            }

            return debouncedCallback;
        }


        // =====================================================================
        // COMPONENTS
        // =====================================================================

        function Modal({ title, message, onClose, onConfirm }) {
            return (
                <div
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-200"
                    onClick={onClose}
                >
                    <div
                        className="bg-slate-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 border border-slate-700"
                        onClick={e => e.stopPropagation()}
                    >
                        <h3 className="text-xl font-bold text-white mb-4">{title}</h3>
                        <p className="text-slate-300 mb-6">{message}</p>
                        <div className="flex justify-end space-x-3">
                            <button
                                onClick={onClose}
                                className="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-slate-500"
                            >
                                {onConfirm ? "Cancel" : "OK"}
                            </button>
                            {onConfirm && (
                                <button
                                    onClick={onConfirm}
                                    className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-red-500"
                                >
                                    Delete
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function CreateTripModal({ onClose, onSubmit }) {
            const [name, setName] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (name) { onSubmit(name); }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onClick={onClose}>
                    <form
                        className="bg-slate-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 border border-slate-700"
                        onClick={e => e.stopPropagation()}
                        onSubmit={handleSubmit}
                    >
                        <h3 className="text-xl font-bold text-white mb-4">Create New Trip</h3>
                        <p className="text-slate-300 mb-4">Enter a name for your new trip:</p>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="e.g., 'Summer Vacation'"
                            autoFocus
                        />
                        <div className="flex justify-end space-x-3 mt-6">
                            <button type="button" onClick={onClose} className="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Cancel
                            </button>
                            <button type="submit" className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                                Create
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        function AuthScreen({ onAuthSuccess }) {
            const [isLoginView, setIsLoginView] = useState(true);
            const [username, setUsername] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [modalInfo, setModalInfo] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setModalInfo(null);
                if (isLoginView) {
                    if (!username || !password) {
                        setModalInfo({ title: "Error", message: "Username/Email and password cannot be empty." }); return;
                    }
                } else {
                    if (!username || !email || !password || !confirmPassword) {
                        setModalInfo({ title: "Error", message: "All fields are required for registration." }); return;
                    }
                    if (password !== confirmPassword) {
                        setModalInfo({ title: "Error", message: "Passwords do not match." }); return;
                    }
                    if (password.length < 8) {
                        setModalInfo({ title: "Error", message: "Password must be at least 8 characters long." }); return;
                    }
                    if (!email.includes('@') || !email.includes('.')) {
                        setModalInfo({ title: "Error", message: "Please enter a valid email address." }); return;
                    }
                }
                const url = isLoginView ? '/auth/login' : '/auth/register';
                const body = isLoginView ? { username, password } : { username, email, password, confirmPassword };
                try {
                    const userData = await apiFetch(url, { method: 'POST', body: JSON.stringify(body) });
                    onAuthSuccess(userData);
                } catch (err) {
                    setModalInfo({ title: isLoginView ? "Login Failed" : "Registration Failed", message: err.error || "Unknown error" });
                }
            };

            return (
                <div className="flex items-center justify-center h-full bg-slate-900">
                    <div className="w-full max-w-md p-8 bg-slate-800 rounded-lg shadow-xl border border-slate-700">
                        <h2 className="text-3xl font-bold text-center text-white mb-6">{isLoginView ? 'Travel Planner üó∫' : 'Register'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-slate-300 text-sm font-bold mb-2" htmlFor="username">{isLoginView ? 'Username or Email' : 'Username'}</label>
                                <input id="username" type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder={isLoginView ? "user123 or user@example.com" : "user123"} />
                            </div>
                            {!isLoginView && (
                                <div className="mb-4">
                                    <label className="block text-slate-300 text-sm font-bold mb-2" htmlFor="email">Email</label>
                                    <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="user@example.com" />
                                </div>
                            )}
                            <div className="mb-6">
                                <label className="block text-slate-300 text-sm font-bold mb-2" htmlFor="password">Password</label>
                                <input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                {!isLoginView && (<p className="text-slate-400 text-xs mt-2">Minimum 8 characters.</p>)}
                            </div>
                            {!isLoginView && (
                                <div className="mb-6">
                                    <label className="block text-slate-300 text-sm font-bold mb-2" htmlFor="confirmPassword">Confirm Password</label>
                                    <input id="confirmPassword" type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                </div>
                            )}
                            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                {isLoginView ? 'Login' : 'Register'}
                            </button>
                        </form>
                        <p className="text-center text-slate-400 text-sm mt-6">
                            {isLoginView ? "Don't have an account?" : 'Already have an account?'}
                            <button
                                onClick={() => {
                                    setIsLoginView(!isLoginView); setUsername(''); setEmail(''); setPassword(''); setConfirmPassword(''); setModalInfo(null);
                                }}
                                className="text-indigo-400 hover:text-indigo-300 font-bold ml-2 focus:outline-none"
                            >
                                {isLoginView ? 'Register' : 'Login'}
                            </button>
                        </p>
                    </div>
                    {modalInfo && (<Modal title={modalInfo.title} message={modalInfo.message} onClose={() => setModalInfo(null)} />)}
                </div>
            );
        }

        function WeatherWidget({ lat, lon }) {
            const [weather, setWeather] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!lat || !lon) { setError("No coordinates"); setLoading(false); return; }
                if (!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY === "YOUR_OPENWEATHER_API_KEY") {
                    setError("OpenWeatherMap API key not configured."); setLoading(false); return;
                }
                const fetchWeather = async () => {
                    setLoading(true); setError(null);
                    try {
                        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=en`);
                        if (!response.ok) { throw new Error('Failed to load weather'); }
                        const data = await response.json(); setWeather(data);
                    } catch (e) { console.error(e); setError(e.message); }
                    finally { setLoading(false); }
                };
                fetchWeather();
            }, [lat, lon]);

            if (loading) { return <div className="text-slate-400 text-sm">Loading weather...</div>; }
            if (error) { return <div className="text-red-400 text-sm">{error}</div>; }
            if (!weather) { return null; }

            return (
                <div className="flex items-center space-x-2 text-sm">
                    <img src={`https://openweathermap.org/img/wn/${weather.weather[0].icon}.png`} alt={weather.weather[0].description} className="w-8 h-8 -ml-1" />
                    <div>
                        <span className="font-bold text-slate-200">{Math.round(weather.main.temp)}¬∞C</span>
                        <span className="text-slate-400 ml-1">({weather.weather[0].description})</span>
                    </div>
                </div>
            );
        }

        function TripMap({
            destinations,
            isAddMode,
            onMapClick,
            onMarkerDragEnd,
            poiResults,
            onAddPoiToTrip
        }) {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersLayerRef = useRef(null);
            const poiMarkersLayerRef = useRef(null);
            const routingControlRef = useRef(null);

            const defaultCenter = [48.3794, 31.1656]; // Center of Ukraine
            const defaultZoom = 6;

            const poiIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>'),
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            const defaultIcon = new L.Icon.Default();

            // 1. Effect for map initialization (runs once)
            useEffect(() => {
                if (window.L && mapContainerRef.current && !mapInstanceRef.current) {
                    const map = window.L.map(mapContainerRef.current, {
                        center: defaultCenter,
                        zoom: defaultZoom,
                        scrollWheelZoom: true,
                    });
                    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    markersLayerRef.current = window.L.layerGroup().addTo(map);
                    poiMarkersLayerRef.current = window.L.layerGroup().addTo(map);
                    mapInstanceRef.current = map;
                }
                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                        markersLayerRef.current = null;
                        poiMarkersLayerRef.current = null;
                        routingControlRef.current = null;
                    }
                };
            }, []);

            // 2. Effect for 'Add Mode'
            useEffect(() => {
                if (!mapInstanceRef.current) return;
                const map = mapInstanceRef.current;

                if (isAddMode) {
                    L.DomUtil.addClass(map.getContainer(), 'add-mode-cursor');
                    map.on('click', onMapClick);
                } else {
                    L.DomUtil.removeClass(map.getContainer(), 'add-mode-cursor');
                    map.off('click', onMapClick);
                }

                return () => {
                     L.DomUtil.removeClass(map.getContainer(), 'add-mode-cursor');
                     map.off('click', onMapClick);
                }
            }, [isAddMode, onMapClick, mapInstanceRef.current]);

            // 3. Effect for updating markers, route, and center
            useEffect(() => {
                if (!mapInstanceRef.current || !markersLayerRef.current) return;
                const map = mapInstanceRef.current;
                const markersLayer = markersLayerRef.current;
                markersLayer.clearLayers();
                if (routingControlRef.current) {
                    routingControlRef.current.remove();
                    routingControlRef.current = null;
                }

                if (!destinations || destinations.length === 0) {
                    map.setView(defaultCenter, defaultZoom);
                    return;
                }

                destinations.forEach(dest => {
                    const marker = window.L.marker([dest.lat, dest.lng], {
                        draggable: true,
                        icon: defaultIcon
                    })
                    .bindPopup(dest.name)
                    .addTo(markersLayer);

                    marker.on('dragend', (e) => {
                        onMarkerDragEnd(dest.id, e.target.getLatLng());
                    });
                });

                if (destinations.length >= 2 && window.L.Routing) {
                    const waypoints = destinations.map(d => window.L.latLng(d.lat, d.lng));

                    const routingControl = window.L.Routing.control({
                        waypoints: waypoints,
                        show: false,
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: 'smart',
                        createMarker: () => null,
                        lineOptions: { styles: [{color: '#4f46e5', opacity: 0.8, weight: 6}] }
                    }).addTo(map);
                    routingControlRef.current = routingControl;
                } else if (destinations.length > 0) {
                    try {
                        const bounds = window.L.latLngBounds(destinations.map(d => [d.lat, d.lng]));
                        map.fitBounds(bounds, { padding: [50, 50] });
                    } catch (e) { console.error("Error creating bounds:", e, destinations); }
                }

                setTimeout(() => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.invalidateSize();
                    }
                }, 100);

            }, [destinations, onMarkerDragEnd]);


            // 4. Effect for POI Markers
            useEffect(() => {
                if (!mapInstanceRef.current || !poiMarkersLayerRef.current) return;
                const poiLayer = poiMarkersLayerRef.current;
                poiLayer.clearLayers();

                if (poiResults && poiResults.length > 0) {
                    poiResults.forEach(poi => {
                        const name = poi.tags.name || poi.tags.amenity || 'Point of Interest';
                        const poiMarker = L.marker([poi.lat, poi.lon], { icon: poiIcon })
                            .addTo(poiLayer);

                        poiMarker.bindPopup(`<b>${name}</b><br><i>Click marker to add to trip</i>`);

                        poiMarker.on('click', () => {
                            onAddPoiToTrip({
                                name: name,
                                lat: poi.lat,
                                lon: poi.lon
                            });
                        });
                    });

                    try {
                        const bounds = window.L.latLngBounds(poiResults.map(p => [p.lat, p.lon]));
                        mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50] });
                    } catch(e) { console.error("Error fitting POI bounds", e); }
                }

            }, [poiResults, onAddPoiToTrip]);


            if (!window.L || !window.L.Routing) {
                 return (
                    <div className="h-full w-full rounded-lg bg-slate-700 flex items-center justify-center p-4 text-center">
                        <div className="text-slate-300">
                            { !window.L && <p className="text-red-400">Error: Base Leaflet library (L.js) failed to load.</p> }
                            { window.L && !window.L.Routing && <p>Loading routing engine...</p> }
                        </div>
                    </div>
                 );
            }

            return (
                <div
                    ref={mapContainerRef}
                    className="h-full w-full rounded-lg shadow-lg"
                    style={{ zIndex: 0 }}
                />
            );
        }

        function LocationSearch({ onLocationSelect }) {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const debounceTimer = useRef(null);

            const handleSearch = (searchQuery) => {
                if (debounceTimer.current) { clearTimeout(debounceTimer.current); }
                if (searchQuery.length < 3) { setResults([]); return; }

                setIsLoading(true);
                debounceTimer.current = setTimeout(async () => {
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&accept-language=en`
                        );
                        const data = await response.json();
                        setResults(data);
                    } catch (error) { console.error("Nominatim search error:", error); }
                    finally { setIsLoading(false); }
                }, 500);
            };

            const handleSelect = (result) => {
                onLocationSelect({
                    name: result.display_name.split(',')[0],
                    lat: parseFloat(result.lat),
                    lon: parseFloat(result.lon)
                });
                setQuery('');
                setResults([]);
            };

            return (
                <div className="relative w-full">
                    <input
                        type="text"
                        value={query}
                        onChange={(e) => {
                            setQuery(e.target.value);
                            handleSearch(e.target.value);
                        }}
                        placeholder="Search for a location..."
                        className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                    {isLoading && <div className="text-slate-400 p-2">Searching...</div>}

                    {results.length > 0 && (
                        <ul className="absolute z-10 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {results.map(result => (
                                <li
                                    key={result.place_id}
                                    onClick={() => handleSelect(result)}
                                    className="px-4 py-2 text-slate-300 hover:bg-slate-700 cursor-pointer"
                                >
                                    {result.display_name}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        }

        function AdminPanel({ user, onBack }) {
            const [users, setUsers] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchUsers = async () => {
                    try {
                        const data = await apiFetch('/admin/users');
                        setUsers(data);
                    } catch (err) {
                        setError(err.error || "Failed to load users. Do you have admin rights?");
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchUsers();
            }, []);

            // –í–ò–ö–õ–ò–ö LUCIDE –î–õ–Ø –Ü–ö–û–ù–û–ö
            useEffect(() => {
                if(window.lucide) {
                    window.lucide.createIcons();
                }
            });

            return (
                <div className="w-full md:w-3/4 lg:w-4/5 xl:w-5/6 flex flex-col p-4 md:p-6 h-full">
                    <button
                        className="text-indigo-400 mb-4 text-left self-start"
                        onClick={onBack}
                    >
                        &larr; Back to Trips
                    </button>
                    <h1 className="text-3xl font-bold mb-4">Admin Panel</h1>


                    {isLoading && <p>Loading user list...</p>}
                    {error && <p className="text-red-400">{error}</p>}

                    {!isLoading && !error && (
                         <div className="flex-grow bg-slate-800 rounded-lg p-3 border border-slate-700 overflow-y-auto min-h-0">
                             <p className="mb-4 text-slate-400">Total Users: {users.length}</p>
                            <ul className="divide-y divide-slate-700">
                                {users.map(u => (
                                    <li key={u.id} className="p-3 flex justify-between items-center">
                                        <div>
                                            <span className="font-medium text-white">{u.username}</span>
                                            <span className="text-slate-400 ml-4">({u.email || 'No email'})</span>
                                        </div>
                                        {u.is_admin && (
                                            <span className="ml-2 text-xs bg-yellow-600 text-white font-bold px-2 py-0.5 rounded-full">
                                                Admin
                                            </span>
                                        )}
                                    </li>
))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        }

        function TripManager({ user, onLogout }) {
            const [trips, setTrips] = useState([]);
            const [selectedTripId, setSelectedTripId] = useState(null);
            const [isTripViewVisible, setTripViewVisible] = useState(false);
            const [modalInfo, setModalInfo] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
            const [currentView, setCurrentView] = useState('trips');

            // –ù–æ–≤—ñ —Å—Ç–∞–Ω–∏
            const [isAddMode, setIsAddMode] = useState(false);
            const [isGeocoding, setIsGeocoding] = useState(false);
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);
            const [isOptimizing, setIsOptimizing] = useState(false);
            const [poiMenuDest, setPoiMenuDest] = useState(null);
            const [poiResults, setPoiResults] = useState([]);
            const [isFetchingPoi, setIsFetchingPoi] = useState(false);

            // Debounce –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ—Ç–∞—Ç–æ–∫/–¥–∞—Ç–∏
            const debouncedUpdateDest = useDebounce(async (destId, payload) => {
                try {
                     await apiFetch(`/destinations/${destId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(payload)
                    });
                } catch(err) {
                     setModalInfo({ title: "Save Error", message: err.error || "Failed to save note/date." });
                }
            }, 1000);


            useEffect(() => {
                if (selectedTripId) { localStorage.setItem('lastSelectedTripId', selectedTripId); }
            }, [selectedTripId]);

            useEffect(() => {
                fetchTrips();
            }, []);

            // –ï–§–ï–ö–¢ –î–õ–Ø –ó–ê–ü–£–°–ö–£ LUCIDE
            // –¶–µ–π —Ö—É–∫ —Å–ø—Ä–∞—Ü—é—î —â–æ—Ä–∞–∑—É, –∫–æ–ª–∏ –∑–º—ñ–Ω–∏—Ç—å—Å—è selectedTrip –∞–±–æ poiMenuDest,
            // –æ–Ω–æ–≤–ª—é—é—á–∏ —ñ–∫–æ–Ω–∫–∏ –≤ DOM
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [selectedTrip, poiMenuDest, isAddMode, isOptimizing]); // –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ, —è–∫—ñ –º–æ–∂—É—Ç—å –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤—ñ —ñ–∫–æ–Ω–∫–∏

            const selectedTrip = useMemo(() => {
                return trips.find(t => t.id === selectedTripId);
            }, [trips, selectedTripId]);

            const fetchTrips = async () => {
                setIsLoading(true);
                try {
                    const data = await apiFetch('/trips');
                    setTrips(data);
                    const lastId = parseInt(localStorage.getItem('lastSelectedTripId'), 10);
                    const lastTripExists = data.some(t => t.id === lastId);
                    if (lastTripExists) {
                        setSelectedTripId(lastId);
                    } else if (data.length > 0) {
                        setSelectedTripId(data[0].id);
                    }
                    if (data.length > 0) {
                        setTripViewVisible(true);
                    }
                } catch (err) {
                    setModalInfo({ title: "Error", message: err.error || "Failed to load trips." });
                } finally {
                    setIsLoading(false);
                }
            };

            const handleCreateTrip = () => {
                setIsCreateModalOpen(true);
            };

            const handleSubmitNewTrip = async (name) => {
                if (name) {
                    try {
                        const newTrip = await apiFetch('/trips', {
                            method: 'POST',
                            body: JSON.stringify({ name })
                        });
                        setTrips([...trips, newTrip]);
                        setSelectedTripId(newTrip.id);
                        setTripViewVisible(true);
                        setCurrentView('trips');
                        setIsCreateModalOpen(false);
                    } catch (err) {
                        setModalInfo({ title: "Creation Error", message: err.error || "Failed to create trip." });
                    }
                }
            };

            const handleDeleteTrip = async (tripIdToDelete) => {
                setModalInfo({
                    title: "Confirm Deletion",
                    message: "Are you sure you want to delete this trip?",
                    onConfirm: async () => {
                        try {
                            setModalInfo(null);
                            await apiFetch(`/trips/${tripIdToDelete}`, { method: 'DELETE' });
                            const updatedTrips = trips.filter(t => t.id !== tripIdToDelete);
                            setTrips(updatedTrips);
                            if (selectedTripId === tripIdToDelete) {
                                const newSelectedId = updatedTrips.length > 0 ? updatedTrips[0].id : null;
                                setSelectedTripId(newSelectedId);
                                if(newSelectedId) {
                                     localStorage.setItem('lastSelectedTripId', newSelectedId);
                                } else {
                                     localStorage.removeItem('lastSelectedTripId');
                                }
                                if (updatedTrips.length === 0) {
                                    setTripViewVisible(false);
                                }
                            }
                        } catch (err) {
                            setModalInfo({ title: "Deletion Error", message: err.error || "Failed to delete trip." });
                        }
                    }
                });
            };

            const handleAddDestination = async (location) => {
                if (!selectedTripId) return;
                try {
                    const newDest = await apiFetch(`/trips/${selectedTripId}/destinations`, {
                        method: 'POST',
                        body: JSON.stringify(location)
                    });
                    const updatedTrips = trips.map(trip => {
                        if (trip.id === selectedTripId) {
                            return { ...trip, destinations: [...trip.destinations, newDest] };
                        }
                        return trip;
                    });
                    setTrips(updatedTrips);
                    setPoiResults([]); // –û—á–∏—Å—Ç–∏—Ç–∏ POI-–º–∞—Ä–∫–µ—Ä–∏
                } catch (err) {
                    setModalInfo({ title: "Error", message: err.error || "Failed to add location." });
                }
            };

            const handleDeleteDestination = async (destId) => {
                 if (!selectedTripId) return;
                 try {
                    await apiFetch(`/destinations/${destId}`, { method: 'DELETE' });
                    const updatedTrips = trips.map(trip => {
                        if (trip.id === selectedTripId) {
                            return {
                                ...trip,
                                destinations: trip.destinations.filter(d => d.id !== destId)
                            };
                        }
                        return trip;
                    });
                    setTrips(updatedTrips);
                 } catch (err) {
                    setModalInfo({ title: "Error", message: err.error || "Failed to delete location." });
                 }
            };

            const handleLogout = async () => {
                try {
                    await apiFetch('/auth/logout', { method: 'POST' });
                    localStorage.removeItem('lastSelectedTripId');
                    onLogout();
                } catch (err) {
                     setModalInfo({ title: "Error", message: err.error || "Failed to log out." });
                }
            };

            // –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è 1: –ö–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—ñ
            const handleMapClick = async (e) => {
                if (!isAddMode || isGeocoding) return;
                setIsGeocoding(true);
                try {
                    const { lat, lng } = e.latlng;
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=en`);
                    if (!response.ok) throw new Error("Reverse geocoding failed");
                    const data = await response.json();
                    const name = data.display_name.split(',')[0] || "Clicked Location";
                    await handleAddDestination({ name, lat, lon: lng });
                } catch(err) {
                    console.error(err);
                    setModalInfo({ title: "Error", message: err.message || "Could not get location name." });
                } finally {
                    setIsGeocoding(false);
                    setIsAddMode(false);
                }
            };

            // Drag-and-drop –º–∞—Ä–∫–µ—Ä—ñ–≤
            const handleMarkerDragEnd = async (destId, newLatLng) => {
                const { lat, lng } = newLatLng;
                // 1. –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–∏—Ç—Ç—î–≤–æ–≥–æ –≤—ñ–¥–≥—É–∫—É
                setTrips(prevTrips => prevTrips.map(trip => {
                    if (trip.id !== selectedTripId) return trip;
                    return {
                        ...trip,
                        destinations: trip.destinations.map(dest =>
                            dest.id === destId ? { ...dest, lat, lng } : dest
                        )
                    };
                }));
                // 2. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –±–µ–∫–µ–Ω–¥
                try {
                    await apiFetch(`/destinations/${destId}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ lat, lng })
                    });
                } catch(err) {
                    setModalInfo({ title: "Save Error", message: err.error || "Failed to save new location." });
                }
            };

            // Drag-and-drop —Å–ø–∏—Å–∫—É
            const handleDragStart = (e, destId) => {
                dragItem.current = destId;
                e.target.classList.add('dragging');
            };

            const handleDragEnter = (e, destId) => {
                dragOverItem.current = destId;
                e.target.classList.add('drag-over');
            };

            const handleDragLeave = (e) => {
                 e.target.classList.remove('drag-over');
            };

            const handleDrop = async (e) => {
                e.target.classList.remove('drag-over');
                e.target.classList.remove('dragging');
                if (dragItem.current === dragOverItem.current) {
                    dragItem.current = null;
                    dragOverItem.current = null;
                    return;
                }

                let newDestinations = [...selectedTrip.destinations];
                const dragItemIndex = newDestinations.findIndex(d => d.id === dragItem.current);
                const hoverItemIndex = newDestinations.findIndex(d => d.id === dragOverItem.current);
                const [draggedItem] = newDestinations.splice(dragItemIndex, 1);
                newDestinations.splice(hoverItemIndex, 0, draggedItem);

                // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å–∏ –¥–ª—è –ë–î
                newDestinations = newDestinations.map((dest, index) => ({ ...dest, order_index: index }));

                // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ
                setTrips(prevTrips => prevTrips.map(trip =>
                    trip.id === selectedTripId ? { ...trip, destinations: newDestinations } : trip
                ));

                dragItem.current = null;
                dragOverItem.current = null;

                // –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–æ–≤–∏–π –ø–æ—Ä—è–¥–æ–∫ –Ω–∞ –±–µ–∫–µ–Ω–¥
                try {
                    const destinationIds = newDestinations.map(d => d.id);
                    await apiFetch(`/trips/${selectedTripId}/destinations/reorder`, {
                        method: 'POST',
                        body: JSON.stringify({ destination_ids: destinationIds })
                    });
                } catch(err) {
                     setModalInfo({ title: "Save Error", message: err.error || "Failed to save new order." });
                }
            };

            const handleDragEnd = (e) => {
                e.target.classList.remove('dragging');
                dragItem.current = null;
                dragOverItem.current = null;
            };

            // –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –º–∞—Ä—à—Ä—É—Ç—É
            const handleOptimizeRoute = async () => {
                if (!selectedTrip || selectedTrip.destinations.length < 3) {
                     setModalInfo({ title: "Optimization", message: "You need at least 3 destinations to optimize a route." });
                     return;
                }
                setIsOptimizing(true);
                try {
                    const coords = selectedTrip.destinations.map(d => `${d.lng},${d.lat}`).join(';');
                    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ OSRM Trip service
                    const response = await fetch(`https://router.project-osrm.org/trip/v1/driving/${coords}?roundtrip=false&source=first`);
                    if (!response.ok) throw new Error("OSRM optimization failed");
                    const data = await response.json();
                    if (data.code !== "Ok") throw new Error(data.message || "Optimization failed");

                    // OSRM –ø–æ–≤–µ—Ä—Ç–∞—î 'waypoints' —É –Ω–æ–≤–æ–º—É, –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É
                    const newDestinations = data.waypoints
                        .map(wp => selectedTrip.destinations[wp.original_index]) // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –æ–±'—î–∫—Ç–∏
                        .map((dest, index) => ({ ...dest, order_index: index })); // –û–Ω–æ–≤–ª—é—î–º–æ —ó—Ö —ñ–Ω–¥–µ–∫—Å–∏

                    setTrips(prevTrips => prevTrips.map(trip =>
                        trip.id === selectedTripId ? { ...trip, destinations: newDestinations } : trip
                    ));

                    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–æ–≤–∏–π –ø–æ—Ä—è–¥–æ–∫ –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ
                    const destinationIds = newDestinations.map(d => d.id);
                    await apiFetch(`/trips/${selectedTripId}/destinations/reorder`, {
                        method: 'POST',
                        body: JSON.stringify({ destination_ids: destinationIds })
                    });
                } catch(err) {
                    setModalInfo({ title: "Optimization Error", message: err.message || "Could not optimize route." });
                } finally {
                    setIsOptimizing(false);
                }
            };

            // –ù–æ—Ç–∞—Ç–∫–∏ —ñ –¥–∞—Ç–∏
            const handleDestUpdate = (destId, payload) => {
                // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ–≥–∞–π–Ω–æ
                setTrips(prevTrips => prevTrips.map(trip => {
                    if (trip.id !== selectedTripId) return trip;
                    return {
                        ...trip,
                        destinations: trip.destinations.map(dest =>
                            dest.id === destId ? { ...dest, ...payload } : dest
                        )
                    };
                }));
                // –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–∞ –±–µ–∫–µ–Ω–¥ –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é
                debouncedUpdateDest(destId, payload);
            };

            // –ü–æ—à—É–∫ POI
            const handleShowPoiMenu = (dest) => {
                if (poiMenuDest && poiMenuDest.id === dest.id) {
                    setPoiMenuDest(null); // –ó–∞–∫—Ä–∏—Ç–∏, —è–∫—â–æ –∫–ª—ñ–∫–Ω—É–ª–∏ –≤–¥—Ä—É–≥–µ
                } else {
                    setPoiMenuDest(dest);
                }
                setPoiResults([]); // –ó–∞–≤–∂–¥–∏ –æ—á–∏—â–∞—Ç–∏ —Å—Ç–∞—Ä—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
            };

            const handleFetchPoi = async (type) => {
                if (!poiMenuDest) return;
                setIsFetchingPoi(true);
                setPoiResults([]);
                try {
                    const { lat, lng } = poiMenuDest;
                    const radius = 1000; // 1 –∫–º
                    // –ó–∞–ø–∏—Ç –¥–æ Overpass API
                    const query = `
                        [out:json][timeout:25];
                        (
                          node[amenity=${type}](around:${radius},${lat},${lng});
                          way[amenity=${type}](around:${radius},${lat},${lng});
                          relation[amenity=${type}](around:${radius},${lat},${lng});
                        );
                        out body;
                        >;
                        out skel qt;
                    `;
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        body: query
                    });
                    if (!response.ok) throw new Error("Overpass API request failed");
                    const data = await response.json();

                    // –û–±—Ä–æ–±–∫–∞ 'way' –µ–ª–µ–º–µ–Ω—Ç—ñ–≤, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —ó—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                    const processedElements = data.elements.map(el => {
                        if (el.type === 'way' && el.nodes && el.nodes.length > 0) {
                            // –î–ª—è 'way' –±–µ—Ä–µ–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø–µ—Ä—à–æ—ó –Ω–æ–¥–∏ —è–∫ —Ü–µ–Ω—Ç—Ä
                            const centerNode = data.elements.find(n => n.type === 'node' && n.id === el.nodes[0]);
                            return { ...el, ...centerNode, id: el.id }; // –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ 'way' –∑ 'lat/lon'
                        }
                        return el;
                    }).filter(el => el.lat && el.lon); // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ª–∏—à–µ —Ç—ñ, —â–æ –º–∞—é—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏

                    setPoiResults(processedElements);
                } catch(err) {
                    setModalInfo({ title: "POI Error", message: err.message || "Could not fetch Points of Interest." });
                } finally {
                    setIsFetchingPoi(false);
                    setPoiMenuDest(null); // –ó–∞–∫—Ä–∏—Ç–∏ –º–µ–Ω—é
                }
            };

            // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Add to Trip" –Ω–∞ POI-–º–∞—Ä–∫–µ—Ä—ñ
            const handleAddPoiToTrip = (location) => {
                handleAddDestination(location);
                setPoiResults([]); // –û—á–∏—Å—Ç–∏—Ç–∏ POI-–º–∞—Ä–∫–µ—Ä–∏
            };

            if (isLoading) {
                 return <div className="flex items-center justify-center h-full text-xl">Loading...</div>;
            }

            // –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó POI
            const POI_CATEGORIES = [
                { name: "Restaurants", type: "restaurant", icon: "utensils" },
                { name: "Hotels", type: "hotel", icon: "hotel" },
                { name: "Museums", type: "museum", icon: "landmark" }
            ];

            return (
                <div className="flex h-full flex-col md:flex-row">
                    {/* Sidebar */}
                    <div className={`${isTripViewVisible && currentView === 'trips' ? 'hidden md:flex' : 'flex'} w-full md:w-1/4 lg:w-1/5 xl:w-1/6 bg-slate-800 border-r border-slate-700 flex-col p-4`}>
                        <div className="mb-6">
                            <h2 className="text-xl font-bold">Hello, {user.username}!</h2>
                            <button
                                onClick={handleLogout}
                                className="text-sm text-indigo-400 hover:text-indigo-300 focus:outline-none"
                            >
                                (Logout)
                            </button>
                        </div>

                        <button
                            onClick={handleCreateTrip}
                            className="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-2 px-4 rounded-lg mb-4 transition-all duration-200 shadow-lg"
                        >
                            + Create Trip
                        </button>

                        <h3 className="text-lg font-semibold mb-2">My Trips</h3>
                        <div className="flex-grow overflow-y-auto pr-2 min-h-0">
                            {trips.length === 0 && (
                                <p className="text-slate-400">You have no trips yet.</p>
                            )}
                            <ul>
                                {trips.map(trip => (
                                    <li
                                        key={trip.id}
                                        className={`p-3 rounded-lg mb-2 cursor-pointer transition-all duration-200 group ${selectedTripId === trip.id && currentView === 'trips' ? 'bg-indigo-700' : 'hover:bg-slate-700'}`}
                                        onClick={() => {
                                            setSelectedTripId(trip.id);
                                            setTripViewVisible(true);
                                            setCurrentView('trips');
                                            setPoiResults([]); // –û—á–∏—Å—Ç–∏—Ç–∏ POI –ø—Ä–∏ –∑–º—ñ–Ω—ñ –ø–æ—ó–∑–¥–∫–∏
                                            setPoiMenuDest(null);
                                        }}
                                    >
                                        <div className="flex justify-between items-center">
                                            <span className="font-medium">{trip.name}</span>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleDeleteTrip(trip.id);
                                                }}
                                                className="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        <div className="mt-auto pt-4 border-t border-slate-700">
                            {user.is_admin && (
                                <button
                                    onClick={() => {
                                        setCurrentView('admin');
                                        setTripViewVisible(true);
                                    }}
                                    className={`w-full text-left p-2 rounded-lg mb-2 transition-all duration-200 ${currentView === 'admin' ? 'bg-indigo-700 text-white' : 'text-indigo-400 hover:text-indigo-300 hover:bg-slate-700'}`}
                                >
                                    Admin Panel
                                </button>
                            )}
                             <a
                                href="/about"
                                className="text-sm text-slate-400 hover:text-slate-300 mt-2 block text-center"
                            >
                                About
                            </a>
                        </div>
                    </div>

                    {/* Main Content */}
                    {currentView === 'trips' ? (
                         <div className={`${isTripViewVisible ? 'flex' : 'hidden md:flex'} w-full md:w-3/4 lg:w-4/5 xl:w-5/6 flex-col p-4 md:p-6 h-full`}>
                            {!selectedTrip ? (
                                <div className="flex items-center justify-center h-full">
                                    <p className="text-xl text-slate-400">
                                        {trips.length > 0 ? 'Select a trip from the list' : 'Create your first trip'}
                                    </p>
                                </div>
                            ) : (
                                <div className="flex flex-col h-full">
                                    <button
                                        className="md:hidden text-indigo-400 mb-2 text-left"
                                        onClick={() => setTripViewVisible(false)}
                                    >
                                        &larr; Back to trip list
                                    </button>
                                    <h1 className="text-4xl font-bold mb-4">{selectedTrip.name}</h1>
                                    <div className="flex flex-col sm:flex-row gap-4 mb-4">
                                        <div className="flex-grow">
                                            <LocationSearch onLocationSelect={handleAddDestination} />
                                        </div>
                                        <div className="flex gap-2 flex-shrink-0">
                                            <button
                                                onClick={() => setIsAddMode(!isAddMode)}
                                                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${isAddMode ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-200 hover:bg-slate-600'}`}
                                            >
                                                {isAddMode ? <i data-lucide="check" style={{width:18, height:18}}></i> : <i data-lucide="map-pin" style={{width:18, height:18}}></i>}
                                                {isGeocoding ? "..." : (isAddMode ? "On" : "Add by Click")}
                                            </button>
                                            <button
                                                onClick={handleOptimizeRoute}
                                                disabled={isOptimizing || selectedTrip.destinations.length < 3}
                                                className="flex items-center gap-2 px-4 py-2 rounded-lg font-medium bg-slate-700 text-slate-200 hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                                title={selectedTrip.destinations.length < 3 ? "Add at least 3 destinations to optimize" : "Optimize route"}
                                            >
                                                <i data-lucide="arrow-down-up" style={{width:18, height:18}}></i>
                                                {isOptimizing ? "Optimizing..." : "Optimize"}
                                            </button>
                                        </div>
                                    </div>
                                    <div className="flex flex-col md:flex-row flex-grow min-h-0 gap-4">
                                        <div className="w-full md:w-1/3 h-1/2 md:h-full flex flex-col">
                                            <h3 className="text-xl font-semibold mb-2">Locations</h3>
                                            <div className="flex-grow bg-slate-800 rounded-lg p-3 overflow-y-auto border border-slate-700 min-h-0">
                                                {selectedTrip.destinations.length === 0 && (
                                                    <p className="text-slate-400">Add locations using search or "Add by Click".</p>
                                                )}
                                                <ul>
                                                    {selectedTrip.destinations.map(dest => (
                                                        <li
                                                            key={dest.id}
                                                            className="mb-4 p-3 bg-slate-700 rounded-lg shadow-md group relative"
                                                            draggable="true"
                                                            onDragStart={(e) => handleDragStart(e, dest.id)}
                                                            onDragEnter={(e) => handleDragEnter(e, dest.id)}
                                                            onDragLeave={handleDragLeave}
                                                            onDragEnd={handleDragEnd}
                                                            onDrop={handleDrop}
                                                            onDragOver={(e) => e.preventDefault()}
                                                        >
                                                            <div className="absolute top-3 left-1 text-slate-500 cursor-move opacity-30 group-hover:opacity-100">
                                                                <i data-lucide="grip-vertical" style={{width:18, height:18}}></i>
                                                            </div>
                                                            <div className="flex justify-between items-start ml-4">
                                                                <span className="font-medium text-white">{dest.name}</span>
                                                                <button onClick={() => handleDeleteDestination(dest.id)} className="text-slate-400 hover:text-red-500 text-lg -mt-1 z-10">‚úï</button>
                                                            </div>
                                                            <div className="ml-4">
                                                                <WeatherWidget lat={dest.lat} lon={dest.lng} />
                                                                <input
                                                                    type="date"
                                                                    defaultValue={dest.visit_date || ''}
                                                                    onChange={(e) => handleDestUpdate(dest.id, { visit_date: e.target.value })}
                                                                    className="w-full bg-slate-600 text-slate-200 text-sm rounded mt-2 px-2 py-1 border border-slate-500"
                                                                />
                                                                <textarea
                                                                    placeholder="Your notes..."
                                                                    defaultValue={dest.notes || ''}
                                                                    onChange={(e) => handleDestUpdate(dest.id, { notes: e.target.value })}
                                                                    className="w-full bg-slate-600 text-slate-200 text-sm rounded mt-2 px-2 py-1 border border-slate-500 h-16 resize-none"
                                                                />
                                                                <button
                                                                    onClick={() => handleShowPoiMenu(dest)}
                                                                    className={`mt-2 flex items-center gap-1 text-sm ${poiMenuDest && poiMenuDest.id === dest.id ? 'text-indigo-300' : 'text-indigo-400'} hover:text-indigo-300`}
                                                                >
                                                                    <i data-lucide="search" style={{width:16, height:16}}></i> Find nearby
                                                                </button>
                                                                {poiMenuDest && poiMenuDest.id === dest.id && (
                                                                    <div className="mt-2 p-2 bg-slate-800 rounded border border-slate-600">
                                                                        {isFetchingPoi ? <p className="text-slate-400 text-sm">Searching...</p> : (
                                                                            <div className="flex flex-wrap gap-2">
                                                                                {POI_CATEGORIES.map(cat => (
                                                                                    <button
                                                                                        key={cat.type}
                                                                                        onClick={() => handleFetchPoi(cat.type)}
                                                                                        className="flex items-center gap-2 text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded"
                                                                                    >
                                                                                        <i data-lucide={cat.icon} style={{width:18, height:18}}></i> {cat.name}
                                                                                    </button>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>
                                        <div className="w-full md:w-2/3 h-1/2 md:h-full min-h-[300px] md:min-h-0 overflow-hidden rounded-lg shadow-lg border border-slate-700">
                                            <TripMap
                                                destinations={selectedTrip.destinations}
                                                isAddMode={isAddMode}
                                                onMapClick={handleMapClick}
                                                onMarkerDragEnd={handleMarkerDragEnd}
                                                poiResults={poiResults}
                                                onAddPoiToTrip={handleAddPoiToTrip}
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <AdminPanel user={user} onBack={() => setCurrentView('trips')} />
                    )}
                    {modalInfo && (
                        <Modal
                            title={modalInfo.title}
                            message={modalInfo.message}
                            onClose={() => setModalInfo(null)}
                            onConfirm={modalInfo.onConfirm}
                        />
                    )}
                    {isCreateModalOpen && (
                        <CreateTripModal
                            onClose={() => setIsCreateModalOpen(false)}
                            onSubmit={handleSubmitNewTrip}
                        />
                    )}
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const checkAuthStatus = async () => {
                    try {
                        const data = await apiFetch('/auth/status');
                        if (data.isAuthenticated) {
                            setUser(data.user);
                        }
                    } catch (error) {
                        console.error("Could not check auth status: ", error.error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                checkAuthStatus();
            }, []);

            const handleLogin = (userData) => {
                setUser(userData);
            };

            const handleLogout = () => {
                setUser(null);
            };

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center h-full text-xl">
                        Loading...
                    </div>
                );
            }

            return (
                <div className="h-full">
                    {user ? (
                        <TripManager user={user} onLogout={handleLogout} />
                    ) : (
                        <AuthScreen onAuthSuccess={handleLogin} />
                    )}
                </div>
            );
        }

        // =====================================================================
        // REACT INITIALIZATION
        // =====================================================================

        function startApp() {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }

        let attempts = 0;
        function checkReactAndStart() {
            if (window.React && window.ReactDOM && window.L && window.L.Routing && window.lucide) {
                console.log("React, ReactDOM, Leaflet (L), L.Routing, and Lucide loaded. Starting App...");
                startApp();
            } else if (attempts < 50) { // 5 seconds
                attempts++;
                setTimeout(checkReactAndStart, 100);
            } else {
                console.error("Critical Error: Libraries failed to load.");
                let errorMsg = "Critical Error: Failed to load base libraries. Missing: ";
                if (!window.React) errorMsg += "React ";
                if (!window.ReactDOM) errorMsg += "ReactDOM ";
                if (!window.L) errorMsg += "Leaflet ";
                if (!window.L.Routing) errorMsg += "Leaflet-Routing ";
                if (!window.lucide) errorMsg += "Lucide-Icons ";
                document.getElementById('root').innerHTML = `<div class="flex items-center justify-center h-full text-xl text-red-500 p-8">${errorMsg}</div>`;
            }
        }

        checkReactAndStart();
{% endraw %}
    </script>
</body>
</html>