<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Travel Planner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js" crossorigin="anonymous"></script>

    <!-- Babel (для JSX) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.24.0/babel.min.js" crossorigin="anonymous"></script>

    <!-- Leaflet CSS (для карти) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Leaflet Routing Machine (Плагін для маршрутів) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>


    <style>
        /* Leaflet styles */
        .leaflet-container {
            height: 100%;
            width: 100%;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* bg-slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* bg-slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* bg-slate-500 */
        }

        /* Стилі для приховування панелі інструкцій маршрутизатора */
        .leaflet-routing-container.leaflet-bar {
            display: none !important;
        }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans antialiased h-screen">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
{% raw %}

        const { useState, useEffect, useRef, useMemo } = React;

        // =====================================================================
        // GLOBAL SETTINGS
        // =====================================================================

        // URL for Flask backend
        const API_BASE_URL = '/api';

        // Key for OpenWeatherMap
        const OPENWEATHER_API_KEY = "8d0fb6e3ff2da2740be369ffaae8a97c";

        // =====================================================================
        // API CLIENT (for Backend communication)
        // =====================================================================

        const apiFetch = (url, options = {}) => {
            return new Promise(async (resolve, reject) => {
                try {
                    options.headers = options.headers || {};

                    // Add 'Content-Type' ONLY if there is a body
                    if (options.body) {
                        options.headers['Content-Type'] = 'application/json';
                    }

                    const response = await fetch(`${API_BASE_URL}${url}`, options);

                    if (!response.ok) {
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            errorData = { error: `HTTP error! status: ${response.status}` };
                        }
                        return reject(errorData);
                    }

                    if (response.status === 204) {
                        return resolve(null);
                    }

                    const data = await response.json();
                    resolve(data);

                } catch (error) {
                    console.error("Fetch error:", error);
                    reject({ error: "Network error. Server is not responding or an error occurred." });
                }
            });
        };

        // =====================================================================
        // COMPONENTS
        // =====================================================================

        /**
         * Modal window for showing errors.
         */
        function Modal({ title, message, onClose }) {
            return (
                <div
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-200"
                    onClick={onClose}
                >
                    <div
                        className="bg-slate-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 border border-slate-700"
                        onClick={e => e.stopPropagation()}
                    >
                        <h3 className="text-xl font-bold text-white mb-4">{title}</h3>
                        <p className="text-slate-300 mb-6">{message}</p>
                        <button
                            onClick={onClose}
                            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50"
                        >
                            OK
                        </button>
                    </div>
                </div>
            );
        }

        /**
         * Modal window for creating a new trip.
         */
        function CreateTripModal({ onClose, onSubmit }) {
            const [name, setName] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (name) {
                    onSubmit(name);
                }
            };

            return (
                <div
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-200"
                    onClick={onClose}
                >
                    <form
                        className="bg-slate-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 border border-slate-700"
                        onClick={e => e.stopPropagation()}
                        onSubmit={handleSubmit}
                    >
                        <h3 className="text-xl font-bold text-white mb-4">Create New Trip</h3>
                        <p className="text-slate-300 mb-4">Enter a name for your new trip:</p>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="e.g., 'Summer Vacation'"
                            autoFocus
                        />
                        <div className="flex justify-end space-x-3 mt-6">
                            <button
                                type="button"
                                onClick={onClose}
                                className="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-slate-500"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            >
                                Create
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        /**
         * Login and Registration screen.
         */
        function AuthScreen({ onAuthSuccess }) {
            const [isLoginView, setIsLoginView] = useState(true);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [modalInfo, setModalInfo] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setModalInfo(null);

                if (!username || !password) {
                    setModalInfo({ title: "Error", message: "Username and password cannot be empty." });
                    return;
                }

                const url = isLoginView ? '/auth/login' : '/auth/register';

                try {
                    const userData = await apiFetch(url, {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });
                    onAuthSuccess(userData);
                } catch (err) {
                    setModalInfo({ title: isLoginView ? "Login Failed" : "Registration Failed", message: err.error || "Unknown error" });
                }
            };

            return (
                <div className="flex items-center justify-center h-full bg-slate-900">
                    <div className="w-full max-w-md p-8 bg-slate-800 rounded-lg shadow-xl border border-slate-700">
                        <h2 className="text-3xl font-bold text-center text-white mb-6">
                            {isLoginView ? 'Travel Planner' : 'Register'}
                        </h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-slate-300 text-sm font-bold mb-2" htmlFor="username">
                                    Username
                                </label>
                                <input
                                    id="username"
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="user123"
                                />
                            </div>
                            <div className="mb-6">
                                <label className="block text-slate-300 text-sm font-bold mb-2" htmlFor="password">
                                    Password
                                </label>
                                <input
                                    id="password"
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="••••••••"
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            >
                                {isLoginView ? 'Login' : 'Register'}
                            </button>
                        </form>
                        <p className="text-center text-slate-400 text-sm mt-6">
                            {isLoginView ? "Don't have an account?" : 'Already have an account?'}
                            <button
                                onClick={() => setIsLoginView(!isLoginView)}
                                className="text-indigo-400 hover:text-indigo-300 font-bold ml-2 focus:outline-none"
                            >
                                {isLoginView ? 'Register' : 'Login'}
                            </button>
                        </p>
                    </div>

                    {modalInfo && (
                        <Modal
                            title={modalInfo.title}
                            message={modalInfo.message}
                            onClose={() => setModalInfo(null)}
                        />
                    )}
                </div>
            );
        }

        /**
         * Weather widget for a single destination.
         */
        function WeatherWidget({ lat, lon }) {
            const [weather, setWeather] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!lat || !lon) {
                    setError("No coordinates");
                    setLoading(false);
                    return;
                }

                if (!OPENWEATHER_API_KEY || OPENWEATHER_API_KEY === "YOUR_OPENWEATHER_API_KEY") {
                    setError("OpenWeatherMap API key not configured.");
                    setLoading(false);
                    return;
                }

                const fetchWeather = async () => {
                    setLoading(true);
                    setError(null);
                    try {
                        const response = await fetch(
                            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=en`
                        );
                        if (!response.ok) {
                            throw new Error('Failed to load weather');
                        }
                        const data = await response.json();
                        setWeather(data);
                    } catch (e) {
                        console.error(e);
                        setError(e.message);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchWeather();
            }, [lat, lon]);

            if (loading) {
                return <div className="text-slate-400 text-sm">Loading weather...</div>;
            }
            if (error) {
                return <div className="text-red-400 text-sm">{error}</div>;
            }
            if (!weather) {
                return null;
            }

            return (
                <div className="flex items-center space-x-2 text-sm">
                    <img
                        src={`https://openweathermap.org/img/wn/${weather.weather[0].icon}.png`}
                        alt={weather.weather[0].description}
                        className="w-8 h-8 -ml-1"
                    />
                    <div>
                        <span className="font-bold text-slate-200">{Math.round(weather.main.temp)}°C</span>
                        <span className="text-slate-400 ml-1">({weather.weather[0].description})</span>
                    </div>
                </div>
            );
        }

        /**
         * Map Component (Leaflet)
         */
        function TripMap({ destinations }) {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersLayerRef = useRef(null);
            const routingControlRef = useRef(null);

            const defaultCenter = [48.3794, 31.1656]; // Center of Ukraine
            const defaultZoom = 6;

            // 1. Effect for map initialization (runs once)
            useEffect(() => {
                if (window.L && mapContainerRef.current && !mapInstanceRef.current) {
                    console.log("Leaflet (L) found. Initializing map...");

                    const map = window.L.map(mapContainerRef.current, {
                        center: defaultCenter,
                        zoom: defaultZoom,
                        scrollWheelZoom: true,
                    });

                    window.L.tileLayer(
                        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }
                    ).addTo(map);

                    markersLayerRef.current = window.L.layerGroup().addTo(map);
                    mapInstanceRef.current = map;
                }

                return () => {
                    if (mapInstanceRef.current) {
                        console.log("Unmounting map...");
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                        markersLayerRef.current = null;
                        routingControlRef.current = null;
                    }
                };
            }, []); // Empty dependency array = run once

            // 2. Effect for updating markers, route, and center
            useEffect(() => {
                if (!mapInstanceRef.current || !markersLayerRef.current) {
                    return; // Map not initialized yet
                }

                const map = mapInstanceRef.current;
                const markersLayer = markersLayerRef.current;

                // Clear old markers
                markersLayer.clearLayers();

                // Clear old route
                if (routingControlRef.current) {
                    routingControlRef.current.remove();
                    routingControlRef.current = null;
                }

                if (!destinations || destinations.length === 0) {
                    map.setView(defaultCenter, defaultZoom);
                    return; // No destinations
                }

                // --- 1. Add Markers (always) ---
                const markers = [];
                destinations.forEach(dest => {
                    const marker = window.L.marker([dest.lat, dest.lng])
                        .bindPopup(dest.name);
                    markers.push(marker);
                });
                markers.forEach(marker => marker.addTo(markersLayer));

                // --- 2. Add Route (if 2 or more points) ---
                if (destinations.length >= 2 && window.L.Routing) {
                    const waypoints = destinations.map(d => window.L.latLng(d.lat, d.lng));

                    const routingControl = window.L.Routing.control({
                        waypoints: waypoints,
                        show: false, // Hide turn-by-turn panel
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: true, // Auto-zoom to the route
                        createMarker: function() { return null; }, // Use our custom markers
                        lineOptions: {
                            styles: [{color: '#4f46e5', opacity: 0.8, weight: 6}] // Indigo line
                        }
                    }).addTo(map);

                    routingControlRef.current = routingControl;

                } else if (destinations.length > 0) {
                    // If only 1 point, or routing failed, just fit bounds to markers
                    try {
                        const bounds = window.L.latLngBounds(destinations.map(d => [d.lat, d.lng]));
                        map.fitBounds(bounds, { padding: [50, 50] });
                    } catch (e) {
                        console.error("Error creating bounds:", e, destinations);
                    }
                }

                setTimeout(() => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.invalidateSize();
                    }
                }, 100);

            }, [destinations]); // Dependency = destinations

            // Updated loading state
            if (!window.L || !window.L.Routing) {
                 return (
                    <div className="h-full w-full rounded-lg bg-slate-700 flex items-center justify-center p-4 text-center">
                        <div className="text-slate-300">
                            { !window.L && <p className="text-red-400">Error: Base Leaflet library (L.js) failed to load.</p> }
                            { window.L && !window.L.Routing && <p>Loading routing engine...</p> }
                        </div>
                    </div>
                 );
            }

            return (
                <div
                    ref={mapContainerRef}
                    className="h-full w-full rounded-lg shadow-lg"
                    style={{ zIndex: 0 }}
                />
            );
        }

        /**
         * Location search field (with Nominatim)
         */
        function LocationSearch({ onLocationSelect }) {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const debounceTimer = useRef(null);

            const handleSearch = (searchQuery) => {
                if (debounceTimer.current) {
                    clearTimeout(debounceTimer.current);
                }

                if (searchQuery.length < 3) {
                    setResults([]);
                    return;
                }

                setIsLoading(true);
                debounceTimer.current = setTimeout(async () => {
                    try {
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&accept-language=en`
                        );
                        const data = await response.json();
                        setResults(data);
                    } catch (error) {
                        console.error("Nominatim search error:", error);
                    } finally {
                        setIsLoading(false);
                    }
                }, 500); // 500 ms delay
            };

            const handleSelect = (result) => {
                onLocationSelect({
                    name: result.display_name.split(',')[0], // Take the first part of the name
                    lat: parseFloat(result.lat),
                    lon: parseFloat(result.lon)
                });
                setQuery('');
                setResults([]);
            };

            return (
                <div className="relative w-full">
                    <input
                        type="text"
                        value={query}
                        onChange={(e) => {
                            setQuery(e.target.value);
                            handleSearch(e.target.value);
                        }}
                        placeholder="Search for a location..."
                        className="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                    {isLoading && <div className="text-slate-400 p-2">Searching...</div>}

                    {results.length > 0 && (
                        <ul className="absolute z-10 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {results.map(result => (
                                <li
                                    key={result.place_id}
                                    onClick={() => handleSelect(result)}
                                    className="px-4 py-2 text-slate-300 hover:bg-slate-700 cursor-pointer"
                                >
                                    {result.display_name}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        }

        /**
         * Admin Panel Component
         */
        function AdminPanel({ user, onBack }) {
            const [users, setUsers] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchUsers = async () => {
                    try {
                        const data = await apiFetch('/admin/users');
                        setUsers(data);
                    } catch (err) {
                        setError(err.error || "Failed to load users. Do you have admin rights?");
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchUsers();
            }, []);

            return (
                <div className="w-full md:w-3/4 lg:w-4/5 xl:w-5/6 flex flex-col p-4 md:p-6 h-full">
                    <button
                        className="text-indigo-400 mb-4 text-left self-start"
                        onClick={onBack}
                    >
                        &larr; Back to Trips
                    </button>
                    <h1 className="text-3xl font-bold mb-4">Admin Panel</h1>


                    {isLoading && <p>Loading user list...</p>}
                    {error && <p className="text-red-400">{error}</p>}

                    {!isLoading && !error && (
                         <div className="flex-grow bg-slate-800 rounded-lg p-3 border border-slate-700 overflow-y-auto min-h-0">
                             <p className="mb-4 text-slate-400">Total Users: {users.length}</p>
                            <ul className="divide-y divide-slate-700">
                                {users.map(u => (
                                    <li key={u.id} className="p-3 flex justify-between items-center">
                                        <div>
                                            <span className="font-medium text-white">{u.username}</span>
                                            <span className="text-slate-400 ml-4">(ID: {u.id})</span>
                                        </div>
                                        {u.is_admin && (
                                            <span className="ml-2 text-xs bg-yellow-600 text-white font-bold px-2 py-0.5 rounded-full">
                                                Admin
                                            </span>
                                        )}
                                    </li>
))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        }

        /**
         * Main component - Trip Manager.
         */
        function TripManager({ user, onLogout }) {
            const [trips, setTrips] = useState([]);
            const [selectedTripId, setSelectedTripId] = useState(null);

            const [isTripViewVisible, setTripViewVisible] = useState(false);
            const [modalInfo, setModalInfo] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);

            const [currentView, setCurrentView] = useState('trips'); // 'trips' or 'admin'

            // localStorage integration
            useEffect(() => {
                if (selectedTripId) {
                    localStorage.setItem('lastSelectedTripId', selectedTripId);
                }
            }, [selectedTripId]);

            useEffect(() => {
                fetchTrips();
            }, []);

            const selectedTrip = useMemo(() => {
                return trips.find(t => t.id === selectedTripId);
            }, [trips, selectedTripId]);

            // --- API FUNCTIONS ---

            const fetchTrips = async () => {
                setIsLoading(true);
                try {
                    const data = await apiFetch('/trips');
                    setTrips(data);

                    const lastId = parseInt(localStorage.getItem('lastSelectedTripId'), 10);
                    const lastTripExists = data.some(t => t.id === lastId);

                    if (lastTripExists) {
                        setSelectedTripId(lastId);
                    } else if (data.length > 0) {
                        setSelectedTripId(data[0].id);
                    }

                    if (data.length > 0) {
                        setTripViewVisible(true);
                    }
                } catch (err) {
                    setModalInfo({ title: "Error", message: err.error || "Failed to load trips." });
                } finally {
                    setIsLoading(false);
                }
            };

            // Just opens the modal
            const handleCreateTrip = () => {
                setIsCreateModalOpen(true);
            };

            // Handles submission from the new modal
            const handleSubmitNewTrip = async (name) => {
                if (name) {
                    try {
                        const newTrip = await apiFetch('/trips', {
                            method: 'POST',
                            body: JSON.stringify({ name })
                        });
                        setTrips([...trips, newTrip]);
                        setSelectedTripId(newTrip.id);
                        setTripViewVisible(true);
                        setCurrentView('trips');
                        setIsCreateModalOpen(false); // Close modal on success
                    } catch (err) {
                        setModalInfo({ title: "Creation Error", message: err.error || "Failed to create trip." });
                    }
                }
            };

            const handleDeleteTrip = async (tripIdToDelete) => {
                setModalInfo({
                    title: "Confirm Deletion",
                    message: "Are you sure you want to delete this trip?",
                    onConfirm: async () => {
                        try {
                            setModalInfo(null); // Close confirm modal
                            await apiFetch(`/trips/${tripIdToDelete}`, { method: 'DELETE' });

                            const updatedTrips = trips.filter(t => t.id !== tripIdToDelete);
                            setTrips(updatedTrips);

                            if (selectedTripId === tripIdToDelete) {
                                const newSelectedId = updatedTrips.length > 0 ? updatedTrips[0].id : null;
                                setSelectedTripId(newSelectedId);
                                if(newSelectedId) {
                                     localStorage.setItem('lastSelectedTripId', newSelectedId);
                                } else {
                                     localStorage.removeItem('lastSelectedTripId');
                                }

                                if (updatedTrips.length === 0) {
                                    setTripViewVisible(false);
                                }
                            }
                        } catch (err) {
                            setModalInfo({ title: "Deletion Error", message: err.error || "Failed to delete trip." });
                        }
                    }
                });
            };

            // Delete Modal to be reusable for confirmation
            function Modal({ title, message, onClose, onConfirm }) {
                return (
                    <div
                        className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-200"
                        onClick={onClose}
                    >
                        <div
                            className="bg-slate-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 border border-slate-700"
                            onClick={e => e.stopPropagation()}
                        >
                            <h3 className="text-xl font-bold text-white mb-4">{title}</h3>
                            <p className="text-slate-300 mb-6">{message}</p>
                            <div className="flex justify-end space-x-3">
                                <button
                                    onClick={onClose}
                                    className="bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-slate-500"
                                >
                                    {onConfirm ? "Cancel" : "OK"}
                                </button>
                                {onConfirm && (
                                    <button
                                        onClick={onConfirm}
                                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-red-500"
                                    >
                                        Delete
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }


            const handleAddDestination = async (location) => {
                if (!selectedTripId) return;

                try {
                    const newDest = await apiFetch(`/trips/${selectedTripId}/destinations`, {
                        method: 'POST',
                        body: JSON.stringify(location)
                    });

                    const updatedTrips = trips.map(trip => {
                        if (trip.id === selectedTripId) {
                            return { ...trip, destinations: [...trip.destinations, newDest] };
                        }
                        return trip;
                    });
                    setTrips(updatedTrips);

                } catch (err) {
                    setModalInfo({ title: "Error", message: err.error || "Failed to add location." });
                }
            };

            const handleDeleteDestination = async (destId) => {
                 if (!selectedTripId) return;

                 try {
                    await apiFetch(`/destinations/${destId}`, { method: 'DELETE' });

                    const updatedTrips = trips.map(trip => {
                        if (trip.id === selectedTripId) {
                            return {
                                ...trip,
                                destinations: trip.destinations.filter(d => d.id !== destId)
                            };
                        }
                        return trip;
                    });
                    setTrips(updatedTrips);

                 } catch (err) {
                    setModalInfo({ title: "Error", message: err.error || "Failed to delete location." });
                 }
            };

            const handleLogout = async () => {
                try {
                    await apiFetch('/auth/logout', { method: 'POST' });
                    localStorage.removeItem('lastSelectedTripId');
                    onLogout();
                } catch (err) {
                     setModalInfo({ title: "Error", message: err.error || "Failed to log out." });
                }
            };

            // --- RENDER ---

            if (isLoading) {
                 return <div className="flex items-center justify-center h-full text-xl">Loading...</div>;
            }

            return (
                <div className="flex h-full flex-col md:flex-row">
                    {/* Sidebar */}
                    <div className={`${isTripViewVisible && currentView === 'trips' ? 'hidden md:flex' : 'flex'} w-full md:w-1/4 lg:w-1/5 xl:w-1/6 bg-slate-800 border-r border-slate-700 flex-col p-4`}>
                        <div className="mb-6">
                            <h2 className="text-xl font-bold">Hello, {user.username}!</h2>
                            <button
                                onClick={handleLogout}
                                className="text-sm text-indigo-400 hover:text-indigo-300 focus:outline-none"
                            >
                                (Logout)
                            </button>
                        </div>

                        <button
                            onClick={handleCreateTrip}
                            className="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-2 px-4 rounded-lg mb-4 transition-all duration-200 shadow-lg"
                        >
                            + Create Trip
                        </button>

                        <h3 className="text-lg font-semibold mb-2">My Trips</h3>
                        <div className="flex-grow overflow-y-auto pr-2 min-h-0">
                            {trips.length === 0 && (
                                <p className="text-slate-400">You have no trips yet.</p>
                            )}
                            <ul>
                                {trips.map(trip => (
                                    <li
                                        key={trip.id}
                                        className={`p-3 rounded-lg mb-2 cursor-pointer transition-all duration-200 group ${selectedTripId === trip.id && currentView === 'trips' ? 'bg-indigo-700' : 'hover:bg-slate-700'}`}
                                        onClick={() => {
                                            setSelectedTripId(trip.id);
                                            setTripViewVisible(true);
                                            setCurrentView('trips');
                                        }}
                                    >
                                        <div className="flex justify-between items-center">
                                            <span className="font-medium">{trip.name}</span>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleDeleteTrip(trip.id);
                                                }}
                                                className="text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                            >
                                                ✕
                                            </button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </div>

                        <div className="mt-auto pt-4 border-t border-slate-700">
                            {user.is_admin && (
                                <button
                                    onClick={() => {
                                        setCurrentView('admin');
                                        setTripViewVisible(true);
                                    }}
                                    className={`w-full text-left p-2 rounded-lg mb-2 transition-all duration-200 ${currentView === 'admin' ? 'bg-indigo-700 text-white' : 'text-indigo-400 hover:text-indigo-300 hover:bg-slate-700'}`}
                                >
                                    Admin Panel
                                </button>
                            )}
                             <a
                                href="/about"
                                /*target="_blank" */
                                className="text-sm text-slate-400 hover:text-slate-300 mt-2 block text-center"
                            >
                                About
                            </a>
                        </div>
                    </div>

                    {/* Main Content */}

                    {currentView === 'trips' ? (
                         <div className={`${isTripViewVisible ? 'flex' : 'hidden md:flex'} w-full md:w-3/4 lg:w-4/5 xl:w-5/6 flex-col p-4 md:p-6 h-full`}>
                            {!selectedTrip ? (
                                <div className="flex items-center justify-center h-full">
                                    <p className="text-xl text-slate-400">
                                        {trips.length > 0 ? 'Select a trip from the list' : 'Create your first trip'}
                                    </p>
                                </div>
                            ) : (
                                <div className="flex flex-col h-full">
                                    <button
                                        className="md:hidden text-indigo-400 mb-2 text-left"
                                        onClick={() => setTripViewVisible(false)}
                                    >
                                        &larr; Back to trip list
                                    </button>

                                    <h1 className="text-4xl font-bold mb-4">{selectedTrip.name}</h1>

                                    <div className="mb-4">
                                        <LocationSearch onLocationSelect={handleAddDestination} />
                                    </div>

                                    <div className="flex flex-col md:flex-row flex-grow min-h-0 gap-4">
                                        {/* Destinations List */}
                                        <div className="w-full md:w-1/3 h-1/2 md:h-full flex flex-col">
                                            <h3 className="text-xl font-semibold mb-2">Locations</h3>
                                            <div className="flex-grow bg-slate-800 rounded-lg p-3 overflow-y-auto border border-slate-700 min-h-0">
                                                {selectedTrip.destinations.length === 0 && (
                                                    <p className="text-slate-400">Add locations using the search bar.</p>
                                                )}
                                                <ul>
                                                    {selectedTrip.destinations.map(dest => (
                                                        <li key={dest.id} className="mb-4 p-3 bg-slate-700 rounded-lg shadow-md group">
                                                            <div className="flex justify-between items-start">
                                                                <span className="font-medium text-white">{dest.name}</span>
                                                                <button
                                                                    onClick={() => handleDeleteDestination(dest.id)}
                                                                    className="text-slate-400 hover:text-red-500 text-lg -mt-1"
                                                                >
                                                                    ✕
                                                                </button>
                                                            </div>
                                                            <WeatherWidget lat={dest.lat} lon={dest.lng} />
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        </div>

                                        {/* Map */}
                                        <div className="w-full md:w-2/3 h-1/2 md:h-full min-h-[300px] md:min-h-0 overflow-hidden rounded-lg shadow-lg border border-slate-700">
                                            <TripMap destinations={selectedTrip.destinations} />
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <AdminPanel user={user} onBack={() => setCurrentView('trips')} />
                    )}


                    {modalInfo && (
                        <Modal
                            title={modalInfo.title}
                            message={modalInfo.message}
                            onClose={() => setModalInfo(null)}
                            onConfirm={modalInfo.onConfirm} // Pass confirm handler
                        />
                    )}

                    {/* Render the new create modal */}
                    {isCreateModalOpen && (
                        <CreateTripModal
                            onClose={() => setIsCreateModalOpen(false)}
                            onSubmit={handleSubmitNewTrip}
                        />
                    )}
                </div>
            );
        }

        /**
         * Main App Component.
         * Manages authentication state.
         */
        function App() {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const checkAuthStatus = async () => {
                    try {
                        const data = await apiFetch('/auth/status');
                        if (data.isAuthenticated) {
                            setUser(data.user);
                        }
                    } catch (error) {
                        console.error("Could not check auth status: ", error.error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                checkAuthStatus();
            }, []);

            const handleLogin = (userData) => {
                setUser(userData);
            };

            const handleLogout = () => {
                setUser(null);
            };

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center h-full text-xl">
                        Loading...
                    </div>
                );
            }

            return (
                <div className="h-full">
                    {user ? (
                        <TripManager user={user} onLogout={handleLogout} />
                    ) : (
                        <AuthScreen onAuthSuccess={handleLogin} />
                    )}
                </div>
            );
        }

        // =====================================================================
        // REACT INITIALIZATION
        // =====================================================================

        function startApp() {
            const container = document.getElementById('root');
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }

        let attempts = 0;
        // Updated poller to wait for the routing plugin
        function checkReactAndStart() {
            if (window.React && window.ReactDOM && window.L && window.L.Routing) {
                console.log("React, ReactDOM, Leaflet (L), and L.Routing loaded. Starting App...");
                startApp();
            } else if (attempts < 50) { // 5 seconds
                attempts++;
                setTimeout(checkReactAndStart, 100);
            } else {
                console.error("Critical Error: React/ReactDOM/Leaflet/L.Routing failed to load.");
                document.getElementById('root').innerHTML = '<div class="flex items-center justify-center h-full text-xl text-red-500">Critical Error: Failed to load base libraries.</div>';
            }
        }

        checkReactAndStart();
{% endraw %}
    </script>
</body>
</html>